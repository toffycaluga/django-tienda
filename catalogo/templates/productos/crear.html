
{% extends "base.html" %}
{% load form_extras %}
{% block title %}Crear producto{% endblock %}
{% block content %}

<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{% url 'lista_productos' %}">Productos</a></li>
    <li class="breadcrumb-item active" aria-current="page">Crear</li>
  </ol>
</nav>

<form method="post" class="card card-page p-4" novalidate id="form-producto">
  {% csrf_token %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Crear producto</h2>
    <div class="page-actions">
      <a class="btn btn-secondary" href="{% url 'lista_productos' %}">Cancelar</a>
      <button class="btn btn-success" type="submit" id="btn-guardar">
        Guardar
      </button>
    </div>
  </div>

  <!-- Datos principales -->
  <div class="mb-4">
    <h5 class="mb-3">Datos principales</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label" for="{{ form.nombre.id_for_label }}">Nombre *</label>
        <input
          type="text"
          name="{{ form.nombre.name }}"
          id="{{ form.nombre.id_for_label }}"
          value="{{ form.nombre.value|default_if_none:'' }}"
          class="form-control {% if form.nombre.errors %}is-invalid{% endif %}"
          placeholder="Ej: Camiseta edición limitada"
          required
        >
        {% for e in form.nombre.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
      </div>

      <div class="col-md-3">
        <label class="form-label" for="{{ form.precio.id_for_label }}">Precio *</label>
        <div class="input-group">
          <span class="input-group-text">$</span>
          <input
            type="number"
            step="0.01"
            min="0"
            inputmode="decimal"
            name="{{ form.precio.name }}"
            id="{{ form.precio.id_for_label }}"
            value="{{ form.precio.value|default_if_none:'' }}"
            class="form-control {% if form.precio.errors %}is-invalid{% endif %}"
            placeholder="0.00"
            required
          >
        </div>
        <div class="form-text">Usa punto para decimales (ej: 1299.90).</div>
        {% for e in form.precio.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
      </div>

      <div class="col-md-3">
        <label class="form-label" for="{{ form.categoria.id_for_label }}">Categoría *</label>
        {{ form.categoria|add_class:"form-select"|safe }}
        <div class="form-text">
          ¿No ves la categoría? <a href="{% url 'crear_categoria' %}">Crear nueva</a>.
        </div>
        {% for e in form.categoria.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
      </div>

      <div class="col-12">
        <label class="form-label" for="{{ form.descripcion.id_for_label }}">Descripción</label>
        <textarea
          name="{{ form.descripcion.name }}"
          id="{{ form.descripcion.id_for_label }}"
          rows="4"
          class="form-control {% if form.descripcion.errors %}is-invalid{% endif %}"
          placeholder="Características, materiales, usos…"
        >{{ form.descripcion.value|default_if_none:'' }}</textarea>
        {% for e in form.descripcion.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
      </div>
    </div>
  </div>

  <hr class="my-4">

  <!-- Etiquetas -->
  <div class="mb-4">
    <h5 class="mb-3">Etiquetas</h5>
    {% if form.etiquetas %}
      <div class="row row-cols-2 row-cols-md-3 g-2">
        {% for cb in form.etiquetas %}
          <div class="col">
            <div class="form-check">
              {{ cb.tag }}
              <label class="form-check-label" for="{{ cb.id_for_label }}">{{ cb.choice_label }}</label>
            </div>
          </div>
        {% endfor %}
      </div>
      {% for e in form.etiquetas.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
      <div class="form-text">Selecciona todas las que apliquen.</div>
    {% else %}
      <p class="text-secondary mb-0">No hay etiquetas disponibles.</p>
    {% endif %}
  </div>

  <hr class="my-4">

  <!-- Detalles (1:1) -->
  <div class="mb-2">
    <h5 class="mb-3">Detalles del producto</h5>
    <div class="row g-3">
      {% if form.dimensiones %}
        <div class="col-md-6">
          <label class="form-label" for="{{ form.dimensiones.id_for_label }}">Dimensiones</label>
          <input
            type="text"
            name="{{ form.dimensiones.name }}"
            id="{{ form.dimensiones.id_for_label }}"
            value="{{ form.dimensiones.value|default_if_none:'' }}"
            class="form-control {% if form.dimensiones.errors %}is-invalid{% endif %}"
            placeholder="Ej: 30×20×10 cm"
          >
          {% for e in form.dimensiones.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
        </div>
      {% endif %}

      {% if form.peso %}
        <div class="col-md-3">
          <label class="form-label" for="{{ form.peso.id_for_label }}">Peso (kg)</label>
          <input
            type="number"
            step="0.01"
            min="0"
            name="{{ form.peso.name }}"
            id="{{ form.peso.id_for_label }}"
            value="{{ form.peso.value|default_if_none:'' }}"
            class="form-control {% if form.peso.errors %}is-invalid{% endif %}"
            placeholder="Ej: 1.25"
          >
          {% for e in form.peso.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-4">
    <a class="btn btn-secondary" href="{% url 'lista_productos' %}">Cancelar</a>
    <button class="btn btn-success" type="submit" id="btn-guardar-bottom">Guardar</button>
  </div>
</form>

<script>
  // Evita doble envío y muestra un pequeño feedback
  (function() {
    const form = document.getElementById('form-producto');
    const btn1 = document.getElementById('btn-guardar');
    const btn2 = document.getElementById('btn-guardar-bottom');
    function lockButtons() {
      [btn1, btn2].forEach(b => { if (b) { b.disabled = true; b.innerText = 'Guardando…'; } });
    }
    form && form.addEventListener('submit', () => lockButtons());
  })();
</script>

{% endblock %}
